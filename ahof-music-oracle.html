import React, { useState, useEffect } from 'react';
import { Sparkles, RefreshCcw, Volume2, ArrowRight } from 'lucide-react';

// Color Constants
const COLORS = {
  royalBlue: '#263475', // Approx for PANTONE 19-3955 TCX
  wispyClouds: '#dcdcdc', // Approx for PANTONE 11-3900 TCX
  white: '#ffffff',
  textLight: '#f3f4f6',
};

// EXPANDED AHOF Lyrics Database
// Covers Verse, Chorus, Bridge, and Ad-libs to create a true "Book of Answers" vibe.
const LYRICS_DB = [
  // ==============================
  // EP 1: WHO WE ARE
  // ==============================
  
  // --- Rendezvous (그곳에서 다시 만나기로 해) ---
  {
    song: "Rendezvous",
    ko: "수많은 별들 사이, 우린 결국 만날 거야",
    zh: "在無數繁星之間，我們終將相遇。",
    en: "Among countless stars, we will meet eventually."
  },
  {
    song: "Rendezvous",
    ko: "어긋난 시간 속에서도 난 너를 찾아",
    zh: "即便在錯開的時間裡，我也會找到你。",
    en: "Even in aligned time, I look for you."
  },
  {
    song: "Rendezvous",
    ko: "약속해, 그곳에서 다시 만나기로",
    zh: "約定好了，要在那個地方再次相見。",
    en: "Promise me, we'll meet there again."
  },
  {
    song: "Rendezvous",
    ko: "기다림은 길었지만 끝은 아닐 거야",
    zh: "雖然等待很漫長，但這絕不是終點。",
    en: "The wait was long, but this is not the end."
  },
  {
    song: "Rendezvous",
    ko: "눈을 감아도 선명해, 우리의 랑데부",
    zh: "閉上眼依然清晰，我們的 Rendezvous。",
    en: "Even with my eyes closed, it's clear, our Rendezvous."
  },

  // --- The Universe ---
  {
    song: "The Universe",
    ko: "서로 다른 색깔이 모여 하나의 우주가 돼",
    zh: "彼此不同的色彩匯聚，成為了一個宇宙。",
    en: "Different colors come together to become one universe."
  },
  {
    song: "The Universe",
    ko: "작은 점 하나가 선이 되고 면이 되어",
    zh: "一個小點連成線，再擴展成面。",
    en: "A small dot becomes a line, and then a plane."
  },
  {
    song: "The Universe",
    ko: "네가 있는 곳이 곧 나의 궤도야",
    zh: "你在的地方，就是我的軌道。",
    en: "Where you are is my orbit."
  },
  {
    song: "The Universe",
    ko: "무한한 공간 저 너머로 가보자",
    zh: "讓我們前往無限空間的彼端吧。",
    en: "Let's go beyond the infinite space."
  },

  // --- Cosmic Underdog ---
  {
    song: "Cosmic Underdog",
    ko: "비록 꼴찌라 해도, 내 꿈은 우주 최고야",
    zh: "即便我是最後一名，我的夢想也是宇宙第一。",
    en: "Even if I'm in last place, my dream is the best in the universe."
  },
  {
    song: "Cosmic Underdog",
    ko: "누가 비웃든 상관없어, I fly my way",
    zh: "不管誰嘲笑都沒差，我飛我自己的路。",
    en: "No matter who laughs, I fly my way."
  },
  {
    song: "Cosmic Underdog",
    ko: "패배는 쓰지만 다시 일어날 명분이지",
    zh: "雖然失敗苦澀，但那是再次站起的理由。",
    en: "Defeat is bitter, but it's a reason to stand up again."
  },
  {
    song: "Cosmic Underdog",
    ko: "반전의 드라마는 지금부터 시작이야",
    zh: "逆轉的劇本，現在才正要開始。",
    en: "The twist in the drama starts now."
  },

  // --- Incompleted ---
  {
    song: "Incompleted",
    ko: "채워지지 않은 빈칸은 가능성이라 불러",
    zh: "尚未填滿的空白，我們稱之為「可能性」。",
    en: "The unfilled blanks are what we call possibilities."
  },
  {
    song: "Incompleted",
    ko: "완벽하지 않아서 더 아름다운 거야",
    zh: "正因為不完美，才更加美麗。",
    en: "It is more beautiful because it is incomplete."
  },
  {
    song: "Incompleted",
    ko: "조금 서툴러도 괜찮아, 우린 성장 중이니까",
    zh: "稍微笨拙一點也沒關係，因為我們正在成長。",
    en: "It's okay to be a little clumsy, we are growing."
  },
  {
    song: "Incompleted",
    ko: "마침표가 아닌 쉼표를 찍어",
    zh: "別畫下句號，試著畫個逗號吧。",
    en: "Put a comma, not a period."
  },

  // --- AHOF ---
  {
    song: "AHOF",
    ko: "우리의 이야기는 이제 시작일 뿐이야",
    zh: "我們的故事，現在才正要開始。",
    en: "Our story is just beginning."
  },
  {
    song: "AHOF",
    ko: "아홉 개의 빛이 모여 하나를 비춰",
    zh: "九道光芒匯聚，照亮了唯一。",
    en: "Nine lights gather to shine on one."
  },
  {
    song: "AHOF",
    ko: "영원히 기억될 이름, 그건 우리",
    zh: "將被永遠銘記的名字，那就是我們。",
    en: "The name that will be remembered forever, that's us."
  },
  {
    song: "AHOF",
    ko: "이 순간을 잊지 마, Never forget",
    zh: "別忘了這一刻，Never forget。",
    en: "Don't forget this moment, Never forget."
  },

  // ==============================
  // EP 2: The Passage
  // ==============================

  // --- Pinocchio (피노키오는 거짓말을 싫어해) ---
  {
    song: "Pinocchio",
    ko: "내 마음을 숨기는 건 더 이상 싫어",
    zh: "我再也不想隱藏我的真心了。",
    en: "I don't want to hide my heart anymore."
  },
  {
    song: "Pinocchio",
    ko: "거짓말은 하지 않아, 너를 향한 진심이니까",
    zh: "我不說謊，因為這全是對你的真心。",
    en: "I don't lie, because it's my sincerity towards you."
  },
  {
    song: "Pinocchio",
    ko: "코가 길어지지 않아도 알 수 있잖아",
    zh: "就算鼻子沒有變長，你也知道的吧。",
    en: "You know it even if my nose doesn't grow longer."
  },
  {
    song: "Pinocchio",
    ko: "진실은 언제나 너의 눈동자 속에 있어",
    zh: "真相永遠都在你的眼眸之中。",
    en: "The truth is always in your eyes."
  },
  {
    song: "Pinocchio",
    ko: "가면을 벗고 진짜 나를 봐줘",
    zh: "脫下面具，看看真正的我吧。",
    en: "Take off the mask and look at the real me."
  },

  // --- Run at 1.5x Speed ---
  {
    song: "Run at 1.5x Speed",
    ko: "남들보다 조금 더 빠르게, 너에게 갈게",
    zh: "比別人再快一點，我會奔向你。",
    en: "A little faster than others, I'll run to you."
  },
  {
    song: "Run at 1.5x Speed",
    ko: "심장이 터질 듯 뛰어도 멈추지 않아",
    zh: "即便心臟跳得像是要炸裂，我也不會停下。",
    en: "Even if my heart beats like it's going to burst, I won't stop."
  },
  {
    song: "Run at 1.5x Speed",
    ko: "세상은 너무 느려, 우리 속도에 맞춰",
    zh: "這世界太慢了，跟上我們的速度吧。",
    en: "The world is too slow, match our speed."
  },
  {
    song: "Run at 1.5x Speed",
    ko: "숨이 차올라도 좋아, 네가 보이니까",
    zh: "就算喘不過氣也沒關係，因為我看見了你。",
    en: "I don't mind running out of breath, because I see you."
  },
  {
    song: "Run at 1.5x Speed",
    ko: "시간을 앞질러가, Vroom Vroom",
    zh: "超越時間吧，Vroom Vroom。",
    en: "Overtake time, Vroom Vroom."
  },

  // --- Never Lose You ---
  {
    song: "Never Lose You",
    ko: "어둠 속에서도 너라는 빛을 놓지 않을게",
    zh: "即便在黑暗中，我也不會放開「你」這道光。",
    en: "Even in the darkness, I won't let go of the light that is you."
  },
  {
    song: "Never Lose You",
    ko: "손을 꽉 잡아, 절대 놓치지 않아",
    zh: "緊緊抓住手，絕對不會錯過。",
    en: "Hold my hand tight, I won't lose you."
  },
  {
    song: "Never Lose You",
    ko: "너 없는 세상은 상상조차 할 수 없어",
    zh: "沒有你的世界，我連想都不敢想像。",
    en: "I can't even imagine a world without you."
  },
  {
    song: "Never Lose You",
    ko: "폭풍우가 몰아쳐도 널 지킬 거야",
    zh: "就算暴風雨來襲，我也會守護你。",
    en: "Even if a storm rages, I will protect you."
  },

  // --- The Sleeping Diary ---
  {
    song: "The Sleeping Diary",
    ko: "오늘의 아픔은 내일의 추억으로 덮어두자",
    zh: "今天的傷痛，就用明天的回憶蓋過吧。",
    en: "Let's cover today's pain with tomorrow's memories."
  },
  {
    song: "The Sleeping Diary",
    ko: "달빛 아래 적어내린 비밀스러운 이야기",
    zh: "在月光下寫下的，那些秘密的故事。",
    en: "The secret stories written under the moonlight."
  },
  {
    song: "The Sleeping Diary",
    ko: "꿈속에서는 모든 게 이루어질 거야",
    zh: "在夢裡，一切都會實現的。",
    en: "Everything will come true in dreams."
  },
  {
    song: "The Sleeping Diary",
    ko: "잠시 쉬어가도 돼, 아무도 재촉하지 않아",
    zh: "稍微休息一下也沒關係，沒人會催促你。",
    en: "You can rest for a while, no one is rushing you."
  },

  // --- Everything is Love ---
  {
    song: "Everything is Love",
    ko: "모든 건 사랑으로부터 시작되었어",
    zh: "一切都是從愛開始的。",
    en: "Everything started from love."
  },
  {
    song: "Everything is Love",
    ko: "미움 대신 사랑을 심어봐",
    zh: "試著種下愛，而不是仇恨。",
    en: "Plant love instead of hate."
  },
  {
    song: "Everything is Love",
    ko: "네가 웃으면 세상도 따라 웃어",
    zh: "只要你笑，世界也會跟著微笑。",
    en: "If you smile, the world smiles with you."
  },
  
  // --- The Little Star ---
  {
    song: "The Little Star",
    ko: "넘어진 그 자리에서 다시 별이 떠올라",
    zh: "在跌倒的那個地方，星星會再次升起。",
    en: "Where you fell, a star will rise again."
  },
  {
    song: "The Little Star",
    ko: "작고 희미해도 빛나고 있음을 잊지 마",
    zh: "別忘了，即便微小黯淡，你依然在發光。",
    en: "Don't forget you are shining, even if small and dim."
  }
];

// UI Translations
const UI_TEXT = {
  ko: {
    title: "AHOF·음악 해답의 책",
    placeholder: "무엇이 고민이신가요? 마음속 질문을 적어주세요...",
    submitBtn: "해답 구하기",
    waiting: "우주와 공명하는 중...",
    another: "다른 질문하기",
    songLabel: "수록곡",
    transBtn: "해석 보기",
    transLabel: "언어 선택",
    subtitle: "당신의 고민에 대한 AHOF의 한 줄 (for FOHA)"
  },
  zh: {
    title: "AHOF·音樂解答之書",
    placeholder: "你在煩惱什麼？寫下你心中的問題...",
    submitBtn: "尋求解答",
    waiting: "與宇宙頻率共鳴中...",
    another: "問另一個問題",
    songLabel: "收錄曲",
    transBtn: "查看翻譯",
    transLabel: "翻譯語言",
    subtitle: "來自 AHOF 的一句歌詞，回應 FOHA 的心聲"
  },
  en: {
    title: "AHOF·Book of Answers",
    placeholder: "What's on your mind? Write your question here...",
    submitBtn: "Get Answer",
    waiting: "Resonating with the universe...",
    another: "Ask Another Question",
    songLabel: "Song",
    transBtn: "See Translation",
    transLabel: "Translation Language",
    subtitle: "A line from AHOF responding to FOHA"
  }
};

export default function AhofBookOfAnswers() {
  const [lang, setLang] = useState('ko'); // UI Language: ko, zh, en
  const [query, setQuery] = useState('');
  const [status, setStatus] = useState('idle'); // idle, loading, result
  const [answer, setAnswer] = useState(null);
  const [transLang, setTransLang] = useState('zh'); // Translation target: zh or en
  const [showTrans, setShowTrans] = useState(false);
  const [progress, setProgress] = useState(0);

  // Logo URL updated back to Web URL for Preview purposes
  const LOGO_URL = "https://images.plurk.com/Ltzi4Oret256KzbmftbZW.png";

  const handleSuggest = () => {
    if (!query.trim()) return;

    setStatus('loading');
    setProgress(0);
    
    // Simulate resonating process
    const interval = setInterval(() => {
      setProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          return 100;
        }
        return prev + 2; // Speed of loading
      });
    }, 50);

    setTimeout(() => {
      const randomIdx = Math.floor(Math.random() * LYRICS_DB.length);
      setAnswer(LYRICS_DB[randomIdx]);
      setStatus('result');
      setShowTrans(false);
      clearInterval(interval);
    }, 2500); // 2.5s total wait time
  };

  const reset = () => {
    setQuery('');
    setStatus('idle');
    setAnswer(null);
  };

  const currentUI = UI_TEXT[lang];

  return (
    <div 
      className="min-h-screen flex flex-col font-sans transition-colors duration-500"
      style={{ backgroundColor: COLORS.wispyClouds, color: COLORS.royalBlue }}
    >
      {/* Header / Nav */}
      <header className="p-4 flex justify-between items-center shadow-sm bg-white/50 backdrop-blur-md sticky top-0 z-10">
        <div className="flex items-center gap-2 font-bold text-xl tracking-wider">
          <Sparkles size={20} className="text-yellow-500" />
          <span>AHOF</span>
        </div>
        
        <div className="flex gap-2 text-sm font-medium">
          <button 
            onClick={() => setLang('ko')} 
            className={`px-3 py-1 rounded-full transition-all ${lang === 'ko' ? 'bg-[#263475] text-white' : 'hover:bg-gray-200'}`}
          >
            한국어
          </button>
          <button 
            onClick={() => setLang('zh')} 
            className={`px-3 py-1 rounded-full transition-all ${lang === 'zh' ? 'bg-[#263475] text-white' : 'hover:bg-gray-200'}`}
          >
            中文
          </button>
          <button 
            onClick={() => setLang('en')} 
            className={`px-3 py-1 rounded-full transition-all ${lang === 'en' ? 'bg-[#263475] text-white' : 'hover:bg-gray-200'}`}
          >
            ENG
          </button>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-grow flex flex-col items-center justify-center p-6 relative overflow-hidden">
        
        {/* Background Decorative Circles */}
        <div className="absolute top-20 left-10 w-64 h-64 rounded-full bg-blue-200 mix-blend-multiply filter blur-3xl opacity-30 animate-pulse"></div>
        <div className="absolute bottom-20 right-10 w-72 h-72 rounded-full bg-indigo-300 mix-blend-multiply filter blur-3xl opacity-30 animate-pulse delay-1000"></div>

        {/* --- STATE: IDLE (Input) --- */}
        {status === 'idle' && (
          <div className="w-full max-w-lg z-0 animate-fade-in-up">
            <div className="text-center mb-10">
              <h1 className="text-3xl md:text-4xl font-extrabold mb-3 tracking-tight drop-shadow-sm" style={{color: COLORS.royalBlue}}>
                {currentUI.title}
              </h1>
              <p className="text-gray-500 italic font-serif">
                {currentUI.subtitle}
              </p>
            </div>

            <div className="bg-white p-6 rounded-3xl shadow-xl border border-white/50 backdrop-blur-sm transform transition-all hover:scale-[1.01]">
              <textarea
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder={currentUI.placeholder}
                className="w-full h-40 p-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-blue-900/20 resize-none text-lg text-gray-700 placeholder-gray-400 outline-none transition-all"
              />
              
              <div className="mt-6 flex justify-end">
                <button
                  onClick={handleSuggest}
                  disabled={!query.trim()}
                  className={`flex items-center gap-2 px-8 py-4 rounded-full font-bold text-lg shadow-lg transition-all transform hover:-translate-y-1 active:scale-95
                    ${!query.trim() ? 'bg-gray-300 cursor-not-allowed text-gray-500' : 'text-white hover:shadow-blue-900/30'}`}
                  style={{ backgroundColor: !query.trim() ? '' : COLORS.royalBlue }}
                >
                  {currentUI.submitBtn}
                  <ArrowRight size={20} />
                </button>
              </div>
            </div>
          </div>
        )}

        {/* --- STATE: LOADING --- */}
        {status === 'loading' && (
          <div className="flex flex-col items-center justify-center z-0">
            {/* Spinning Logo Container */}
            <div className="relative w-48 h-48 mb-8">
              {/* Spinning Logo */}
              <img 
                src={LOGO_URL} 
                alt="AHOF Logo" 
                onError={(e) => {
                   e.target.onerror = null; 
                   e.target.style.display = 'none';
                   // Fallback visual if image fails
                   e.target.parentNode.classList.add('bg-[#263475]', 'flex', 'items-center', 'justify-center', 'text-white', 'font-bold');
                   e.target.parentNode.innerHTML = '<span class="text-2xl">AHOF</span>';
                }}
                className="w-full h-full object-cover rounded-full shadow-2xl border-4 border-white"
                style={{
                  animation: 'spin 3s linear infinite'
                }}
              />
              {/* Glow effect */}
              <div className="absolute inset-0 rounded-full shadow-[0_0_40px_rgba(38,52,117,0.4)] animate-pulse"></div>
            </div>

            <h2 className="text-xl font-bold mb-4 animate-pulse" style={{ color: COLORS.royalBlue }}>
              {currentUI.waiting}
            </h2>

            {/* Progress Bar */}
            <div className="w-64 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div 
                className="h-full rounded-full transition-all duration-100 ease-out"
                style={{ 
                  width: `${progress}%`,
                  backgroundColor: COLORS.royalBlue
                }}
              ></div>
            </div>
            <p className="mt-2 text-sm font-mono text-gray-500">{progress}%</p>
          </div>
        )}

        {/* --- STATE: RESULT --- */}
        {status === 'result' && answer && (
          <div className="w-full max-w-xl z-0 animate-fade-in-scale">
            
            <div className="bg-white rounded-3xl shadow-2xl overflow-hidden border border-blue-100">
              {/* Card Header */}
              <div className="p-4 bg-gray-50 flex justify-between items-center border-b border-gray-100">
                <span className="text-xs font-bold tracking-widest uppercase text-gray-400">
                  Resonating with: {query.length > 15 ? query.substring(0, 15) + '...' : query}
                </span>
                <div className="flex gap-1">
                  <div className="w-3 h-3 rounded-full bg-red-400"></div>
                  <div className="w-3 h-3 rounded-full bg-yellow-400"></div>
                  <div className="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
              </div>

              {/* Lyric Content */}
              <div className="p-10 text-center flex flex-col items-center justify-center min-h-[300px] relative">
                {/* Quotation Mark Decoration */}
                <span className="absolute top-6 left-6 text-6xl font-serif text-blue-100 leading-none opacity-50">“</span>
                
                {/* Main Korean Text */}
                <h2 className="text-3xl md:text-4xl font-black leading-relaxed mb-6 break-keep" style={{ color: COLORS.royalBlue }}>
                  {answer.ko}
                </h2>

                {/* Translation Display */}
                <div className={`transition-all duration-700 ease-in-out overflow-hidden ${showTrans ? 'max-h-32 opacity-100 mt-2' : 'max-h-0 opacity-0'}`}>
                  <p className="text-lg md:text-xl text-gray-600 font-medium font-serif italic border-t border-gray-200 pt-4 px-4">
                    {transLang === 'zh' ? answer.zh : answer.en}
                  </p>
                </div>

                <span className="absolute bottom-6 right-6 text-6xl font-serif text-blue-100 leading-none opacity-50 rotate-180">“</span>
              </div>

              {/* Song Info & Controls */}
              <div className="bg-[#263475] p-6 text-white">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                  
                  {/* Song Title */}
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                      <Volume2 size={20} />
                    </div>
                    <div className="text-left">
                      <p className="text-xs text-blue-200 uppercase tracking-wider">{currentUI.songLabel}</p>
                      <p className="font-bold text-lg">{answer.song}</p>
                    </div>
                  </div>

                  {/* Controls */}
                  <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                    
                    {/* Translation Toggle */}
                    <div className="flex items-center gap-2 bg-black/20 p-1 rounded-lg">
                      <button 
                         onClick={() => {
                           if (showTrans && transLang === 'zh') {
                             setShowTrans(false);
                           } else {
                             setTransLang('zh');
                             setShowTrans(true);
                           }
                         }}
                         className={`px-3 py-1 text-xs rounded-md transition-all ${showTrans && transLang === 'zh' ? 'bg-white text-[#263475] font-bold' : 'text-blue-200 hover:text-white'}`}
                      >
                        中
                      </button>
                      <div className="w-px h-3 bg-white/20"></div>
                      <button 
                         onClick={() => {
                           if (showTrans && transLang === 'en') {
                             setShowTrans(false);
                           } else {
                             setTransLang('en');
                             setShowTrans(true);
                           }
                         }}
                         className={`px-3 py-1 text-xs rounded-md transition-all ${showTrans && transLang === 'en' ? 'bg-white text-[#263475] font-bold' : 'text-blue-200 hover:text-white'}`}
                      >
                        EN
                      </button>
                    </div>

                  </div>
                </div>
              </div>
            </div>

            {/* Retry Button */}
            <div className="mt-8 text-center">
              <button
                onClick={reset}
                className="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-white border-2 hover:bg-gray-50 transition-all font-semibold shadow-sm text-sm"
                style={{ borderColor: COLORS.royalBlue, color: COLORS.royalBlue }}
              >
                <RefreshCcw size={16} />
                {currentUI.another}
              </button>
            </div>

          </div>
        )}
      </main>

      {/* Footer */}
      <footer className="p-4 text-center text-xs text-gray-400">
        &copy; AHOF Musical Oracle. Fanmade Project by My Jam, My Jay.
      </footer>

      {/* Global Styles for Animations */}
      <style>{`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        @keyframes fade-in-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-in-scale {
          from { opacity: 0; transform: scale(0.95); }
          to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in-up {
          animation: fade-in-up 0.6s ease-out forwards;
        }
        .animate-fade-in-scale {
          animation: fade-in-scale 0.5s ease-out forwards;
        }
      `}</style>
    </div>
  );
}